{% extends "layout/base.html" %}

{% block content %}
<main>
  <div class="container">
    <section class="section">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          
          <!-- Current Credit Status -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0" style="font-size: 1.5rem;">Credit Status</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <strong style="font-size: 1.2rem;">Current Balance:</strong>
                    <span class="fs-4 ms-2 {% if credit_stats.current_balance > 0 %}text-success{% else %}text-danger{% endif %}">
                      {{ credit_stats.current_balance }}
                    </span>
                  </div>
                  <div class="mb-3">
                    <strong style="font-size: 1.2rem;">Added This Month:</strong>
                    <span class="fs-4 ms-2 text-success">{{ credit_stats.total_added_this_month }}</span>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="mb-3">
                    <strong style="font-size: 1.2rem;">Used This Month:</strong>
                    <span class="fs-4 ms-2 text-danger">{{ credit_stats.total_used_this_month }}</span>
                  </div>
                  <div class="mb-3">
                    <strong style="font-size: 1.2rem;">Last Reset:</strong>
                    <span class="fs-4 ms-2">{{ credit_stats.last_reset|date:"M d, Y H:i" }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Add Credits Form -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0" style="font-size: 1.5rem;">Add Credits</h5>
            </div>
            <div class="card-body">
              <form method="post" novalidate class="needs-validation">
                {% csrf_token %}
                <input type="hidden" name="action" value="add_credits">

                <div class="mb-3">
                  <label for="amount" class="form-label" style="font-size: 1.2rem;">Amount</label>
                  <input
                    type="number"
                    name="amount"
                    id="amount"
                    class="form-control {% if form.errors.amount %}is-invalid{% endif %}"
                    required
                    min="1"
                    step="1"
                    style="font-size: 1.2rem;"
                    placeholder="Enter credit amount"
                  />
                  <div class="invalid-feedback">
                    Please enter a valid positive amount.
                  </div>
                </div>

                <div class="mb-3">
                  <label for="description" class="form-label" style="font-size: 1.2rem;">Description (Optional)</label>
                  <textarea
                    name="description"
                    id="description"
                    class="form-control"
                    rows="2"
                    style="font-size: 1.2rem;"
                    placeholder="Describe why credits are being added"
                  ></textarea>
                </div>

                <div class="text-center">
                  <button type="submit" class="btn btn-success" style="font-size: 1.2rem;">
                    <i class="bi bi-plus-circle"></i> Add Credits
                  </button>
                </div>
              </form>
            </div>
          </div>

          <!-- Management Actions -->
          <div class="card mb-4">
            <div class="card-header">
              <h5 class="card-title mb-0" style="font-size: 1.5rem;">Credit Management</h5>
            </div>
            <div class="card-body">
              <div class="row">
                <div class="col-md-6 mb-3">
                  <form method="post" onsubmit="return confirm('Are you sure you want to reset monthly counters?');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="reset_counters">
                    <button type="submit" class="btn btn-warning w-100" style="font-size: 1.2rem;">
                      <i class="bi bi-arrow-clockwise"></i> Reset Monthly Counters
                    </button>
                    <small class="form-text text-muted">Resets monthly totals but keeps current balance</small>
                  </form>
                </div>
                <div class="col-md-6 mb-3">
                  <form method="post" onsubmit="return confirm('WARNING: This will set credit balance to ZERO. Are you sure?');">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="expire_credits">
                    <button type="submit" class="btn btn-danger w-100" style="font-size: 1.2rem;">
                      <i class="bi bi-exclamation-triangle"></i> Expire All Credits
                    </button>
                    <small class="form-text text-muted">Sets balance to zero and resets all counters</small>
                  </form>
                </div>
              </div>
            </div>
          </div>


          <!-- Monthly Summary -->
          <div class="card mt-4">
            <div class="card-header">
              <h5 class="card-title mb-0" style="font-size: 1.5rem;">Monthly Summary</h5>
            </div>
            <div class="card-body">
              <div class="row text-center">
                <div class="col-md-4">
                  <div class="border rounded p-3">
                    <h6 style="font-size: 1.1rem;">Transactions</h6>
                    <h4 class="text-primary">{{ monthly_summary.transactions_count }}</h4>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="border rounded p-3">
                    <h6 style="font-size: 1.1rem;">Added</h6>
                    <h4 class="text-success">{{ monthly_summary.added_this_month }}</h4>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="border rounded p-3">
                    <h6 style="font-size: 1.1rem;">Used</h6>
                    <h4 class="text-danger">{{ monthly_summary.used_this_month }}</h4>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Recent History -->
          <div class="card">
            <div class="card-header">
              <h5 class="card-title mb-0" style="font-size: 1.5rem;">Recent Credit History (Last 7 Days)</h5>
            </div>
            <div class="card-body">
              {% if recent_history %}
                <div class="table-responsive">
                  <table class="table table-striped" style="font-size: 1.1rem;">
                    <thead>
                      <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Description</th>
                        <th>User</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for transaction in recent_history %}
                        <tr>
                          <td>{{ transaction.created_at|date:"M d, H:i" }}</td>
                          <td>
                            <span class="badge 
                              {% if transaction.transaction_type == 'purchase' %}bg-success
                              {% elif transaction.transaction_type == 'usage' %}bg-danger
                              {% else %}bg-secondary{% endif %}">
                              {{ transaction.get_transaction_type_display }}
                            </span>
                          </td>
                          <td class="{% if transaction.amount > 0 %}text-success{% elif transaction.amount < 0 %}text-danger{% endif %}">
                            {% if transaction.amount > 0 %}+{% endif %}{{ transaction.amount }}
                          </td>
                          <td>{{ transaction.description }}</td>
                          <td>{{ transaction.user.username|default:"System" }}</td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              {% else %}
                <p class="text-muted text-center" style="font-size: 1.2rem;">No recent transactions</p>
              {% endif %}
            </div>
          </div>


        </div>
      </div>
    </section>
  </div>
</main>

<!-- Messages Display -->
{% if messages %}
<div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
  {% for message in messages %}
    <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="toast-header 
        {% if message.tags == 'success' %}bg-success text-white
        {% elif message.tags == 'error' %}bg-danger text-white
        {% else %}bg-info text-white{% endif %}">
        <strong class="me-auto">Credit System</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
      </div>
      <div class="toast-body" style="font-size: 1.1rem;">
        {{ message }}
      </div>
    </div>
  {% endfor %}
</div>
{% endif %}

<!-- JavaScript for Client-Side Validation -->
<script>
  (function () {
    'use strict';

    var forms = document.querySelectorAll('.needs-validation');

    Array.prototype.slice.call(forms)
      .forEach(function (form) {
        form.addEventListener('submit', function (event) {
          if (!form.checkValidity()) {
            event.preventDefault();
            event.stopPropagation();
          }
          form.classList.add('was-validated');
        }, false);
      });
  })();

  // Auto-dismiss toasts after 5 seconds
  document.addEventListener('DOMContentLoaded', function() {
    var toasts = document.querySelectorAll('.toast');
    toasts.forEach(function(toast) {
      setTimeout(function() {
        var bsToast = new bootstrap.Toast(toast);
        bsToast.hide();
      }, 5000);
    });
  });
</script>
{% endblock %}