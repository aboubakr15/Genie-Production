<!-- ai_agent/loading.html -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-container">
        <div class="loading-card">
            <!-- Animated Icon -->
            <div class="loading-icon">
                <div class="batch-processor">
                    <div class="processor-core">
                        <div class="core-pulse"></div>
                    </div>
                    <div class="data-stream">
                        <div class="data-point" style="--delay: 0s"></div>
                        <div class="data-point" style="--delay: 0.5s"></div>
                        <div class="data-point" style="--delay: 1s"></div>
                        <div class="data-point" style="--delay: 1.5s"></div>
                    </div>
                </div>
            </div>

            <!-- Loading Text -->
            <div class="loading-text">
                <h3 id="loadingTitle">Processing Companies</h3>
                <p id="loadingSubtext" class="text-muted">Initializing AI enrichment...</p>
            </div>

            <!-- Simplified Progress (only bar and time estimate) -->
            <div class="batch-progress-container">
                <div class="batch-header">
                    <div class="time-estimate" style="margin: 0 auto;">
                        <i class="fas fa-clock"></i>
                        <span id="timeRemaining">Calculating...</span>
                    </div>
                </div>
                
                <!-- Main Progress Bar -->
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div class="progress-percentage">
                        <span id="progressPercentage">0%</span>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="completionStatus" class="completion-status" style="display: none;">
                <div class="status-success">
                    <i class="fas fa-check-circle"></i>
                    <span>Processing complete! Preparing download...</span>
                </div>
            </div>

            <!-- Cancel Button -->
            <div class="cancel-section">
                <button id="cancelBtn" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-times me-1"></i>
                    Cancel Processing
                </button>
            </div>
        </div>
    </div>
</div>

<style>
/* Optimized CSS: Removed unused styles for batches/companies/phases/activity. Simplified layout. */
.loading-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    z-index: 9999;
    display: flex;
    align-items: center;
    justify-content: center;
}

.loading-container {
    max-width: 600px;
    width: 90%;
    animation: slideUp 0.5s ease-out;
}

.loading-card {
    background: linear-gradient(135deg, #1e2a3a 0%, #2d3b4e 100%);
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
    border: 1px solid rgba(255, 255, 255, 0.1);
    color: white;
}

@keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

/* Batch Processor Animation */
.batch-processor { position: relative; width: 100px; height: 80px; margin: 0 auto; }
.processor-core { width: 50px; height: 50px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 50%; margin: 0 auto; position: relative; animation: rotate 3s linear infinite; }
.core-pulse { position: absolute; top: 50%; left: 50%; width: 20px; height: 20px; background: white; border-radius: 50%; transform: translate(-50%, -50%); }
.data-stream { position: absolute; inset: 0; }
.data-point { position: absolute; width: 6px; height: 6px; background: #00f2fe; border-radius: 50%; animation: dataFlow 2s linear infinite; animation-delay: var(--delay); }
.data-point:nth-child(1) { top: 10%; left: 20%; }
.data-point:nth-child(2) { top: 30%; left: 80%; }
.data-point:nth-child(3) { top: 70%; left: 10%; }
.data-point:nth-child(4) { top: 90%; left: 70%; }
@keyframes rotate { to { transform: rotate(360deg); } }
@keyframes dataFlow { 0%, 100% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1); opacity: 1; } }

/* Simplified Progress */
.batch-progress-container { margin: 1.5rem 0; }
.batch-header { display: flex; justify-content: center; align-items: center; margin-bottom: 1rem; }
.time-estimate { display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; opacity: 0.8; }
.progress-container { margin: 1rem 0; }
.progress-bar { height: 10px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden; }
.progress-fill { height: 100%; background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); border-radius: 10px; width: 0; transition: width 0.5s ease; position: relative; }
.progress-fill::after { content: ''; position: absolute; inset: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); animation: shimmer 2s infinite; }
.progress-percentage { text-align: right; margin-top: 0.5rem; font-weight: 600; }

/* Completion Status */
.completion-status { margin: 1rem 0; padding: 1rem; background: rgba(0, 217, 126, 0.1); border-radius: 10px; border-left: 3px solid #00d97e; animation: fadeIn 0.5s ease; }
.status-success { display: flex; align-items: center; gap: 0.75rem; color: #00d97e; font-weight: 600; }
.status-success i { font-size: 1.2rem; }

/* Cancel Button */
.cancel-section { text-align: center; margin-top: 1rem; }
#cancelBtn { border-color: rgba(255, 255, 255, 0.3); color: rgba(255, 255, 255, 0.7); transition: all 0.3s ease; }
#cancelBtn:hover { border-color: #ff6b6b; color: #ff6b6b; background: rgba(255, 107, 107, 0.1); }

.loading-text { text-align: center; margin-bottom: 1.5rem; }
.loading-text h3 { margin-bottom: 0.5rem; font-weight: 600; }

@keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.5; transform: scale(1.2); } }
@keyframes shimmer { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
</style>

<script>
/* Optimized JS: Removed batch/company/phase/activity logic. Kept progress bar and time estimate updates. */
const LoadingManager = {
    checkInterval: null,
    companiesProcessed: 0,
    totalCompanies: 0,
    isComplete: false,
    maxProgressChecks: 300,
    progressCheckCount: 0,
    errorCount: 0,
    maxErrors: 5,
    
    show: function(options) {
        const overlay = document.getElementById('loadingOverlay');
        const title = document.getElementById('loadingTitle');
        const subtext = document.getElementById('loadingSubtext');
        const cancelBtn = document.getElementById('cancelBtn');
        const completionStatus = document.getElementById('completionStatus');
        
        this.reset();
        completionStatus.style.display = 'none';
        
        this.totalCompanies = options.totalCompanies || 0;
        
        title.textContent = options.text || 'Processing Companies';
        subtext.textContent = options.subtext || 'Initializing AI enrichment...';
        
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('progressPercentage').textContent = '0%';
        
        overlay.style.display = 'flex';
        
        cancelBtn.onclick = () => {
            if (confirm('Are you sure you want to cancel the data enrichment process?')) {
                this.hide();
                window.location.reload();
            }
        };
        
        overlay.onclick = e => { if (e.target === overlay) e.stopPropagation(); };
    },
    
    hide: function() {
        document.getElementById('loadingOverlay').style.display = 'none';
        this.reset();
    },
    
    reset: function() {
        this.companiesProcessed = 0;
        this.totalCompanies = 0;
        this.isComplete = false;
        this.progressCheckCount = 0;
        this.errorCount = 0;
        clearInterval(this.checkInterval);
    },
    
    startRealProgressTracking: function() {
        this.checkInterval = setInterval(() => this.checkServerProgress(), 2000);
    },
    
    async checkServerProgress() {
        this.progressCheckCount++;
        if (this.progressCheckCount > this.maxProgressChecks) {
            this.showCompletion(true);
            return;
        }
        
        try {
            const response = await fetch('/ai_agent/enrichment_progress/');
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const progress = await response.json();
            
            this.errorCount = 0;
            
            if (progress.is_complete) {
                progress.companies_processed = this.totalCompanies;
            }
            
            this.updateProgressDisplay(progress);
            
            if ((progress.is_complete || this.companiesProcessed >= this.totalCompanies) && !this.isComplete) {
                this.isComplete = true;
                clearInterval(this.checkInterval);
                this.showCompletion();
            }
        } catch (error) {
            this.errorCount++;
            if (this.errorCount >= this.maxErrors) {
                this.showCompletion(true);
            }
        }
    },
    
    updateProgressDisplay: function(progress) {
        const progressFill = document.getElementById('progressFill');
        const progressPercentage = document.getElementById('progressPercentage');
        const timeRemaining = document.getElementById('timeRemaining');
        
        this.companiesProcessed = progress.companies_processed || 0;
        this.totalCompanies = progress.total_companies || 1;
        
        const percentage = Math.min(100, (this.companiesProcessed / this.totalCompanies) * 100);
        
        progressFill.style.width = `${percentage}%`;
        progressPercentage.textContent = `${Math.round(percentage)}%`;
        
        this.updateTimeEstimate(timeRemaining, percentage);
    },
    
    updateTimeEstimate: function(timeRemainingEl, percentage) {
        if (percentage >= 100) timeRemainingEl.textContent = 'Complete!';
        else if (percentage >= 95) timeRemainingEl.textContent = 'Almost done...';
        else if (percentage >= 80) timeRemainingEl.textContent = 'Less than 1 minute remaining';
        else if (percentage >= 50) timeRemainingEl.textContent = 'About 2 minutes remaining';
        else if (percentage >= 25) timeRemainingEl.textContent = 'About 4 minutes remaining';
        else timeRemainingEl.textContent = 'Calculating...';
    },
    
    showCompletion: function(isTimeout = false) {
        const timeRemaining = document.getElementById('timeRemaining');
        const completionStatus = document.getElementById('completionStatus');
        const cancelBtn = document.getElementById('cancelBtn');
        
        // Force 100%
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressPercentage').textContent = '100%';
        
        timeRemaining.textContent = 'Complete!';
        completionStatus.style.display = 'block';
        
        cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>Close';
        cancelBtn.onclick = () => this.hide();
        
        if (isTimeout) {
            completionStatus.innerHTML = `
                <div class="status-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Process taking longer than expected. The download may appear shortly.</span>
                </div>
            `;
            completionStatus.style.background = 'rgba(255, 193, 7, 0.1)';
            completionStatus.style.borderLeftColor = '#ffc107';
        }
        
        // Reset submit button (if enrich.html context)
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn && window.originalButtonHTML) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-loading');
            submitBtn.innerHTML = window.originalButtonHTML;
        }
        
        // Auto-hide after 5s
        setTimeout(() => this.hide(), 5000);
    }
};

// Hide on load/pageshow
document.addEventListener('DOMContentLoaded', () => LoadingManager.hide());
window.addEventListener('pageshow', event => { if (event.persisted) LoadingManager.hide(); });
</script>