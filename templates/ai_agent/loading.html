<!-- ai_agent/loading.html -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="loading-container">
        <div class="loading-card">
            <!-- Animated Icon -->
            <div class="loading-icon">
                <div class="batch-processor">
                    <div class="processor-core">
                        <div class="core-pulse"></div>
                    </div>
                    <div class="data-stream">
                        <div class="data-point" style="--delay: 0s"></div>
                        <div class="data-point" style="--delay: 0.5s"></div>
                        <div class="data-point" style="--delay: 1s"></div>
                        <div class="data-point" style="--delay: 1.5s"></div>
                    </div>
                </div>
            </div>

            <!-- Loading Text -->
            <div class="loading-text">
                <h3 id="loadingTitle">Processing Companies</h3>
                <p id="loadingSubtext" class="text-muted">Initializing AI enrichment...</p>
            </div>

            <!-- Simplified Progress (only bar and time estimate) -->
            <div class="batch-progress-container">
                <div class="batch-header">
                    <div class="time-estimate" style="margin: 0 auto;">
                        <i class="fas fa-clock"></i>
                        <span id="timeRemaining">Calculating...</span>
                    </div>
                </div>
                
                <!-- Main Progress Bar -->
                <div class="progress-container">
                    <div class="progress-bar">
                        <div id="progressFill" class="progress-fill"></div>
                    </div>
                    <div class="progress-percentage">
                        <span id="progressPercentage">0%</span>
                    </div>
                </div>
            </div>

            <!-- Status Messages -->
            <div id="completionStatus" class="completion-status" style="display: none;">
                <div class="status-success">
                    <i class="fas fa-check-circle"></i>
                    <span>Processing complete! Preparing download...</span>
                </div>
            </div>

            <!-- Cancel Button -->
            <div class="cancel-section">
                <button id="cancelBtn" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-times me-1"></i>
                    Cancel Processing
                </button>
            </div>
        </div>
    </div>
</div>

<script>
/* âœ… Updated JS: Now polls /ai_agent/enrichment_progress/<job_id>/ dynamically */
const LoadingManager = {
    checkInterval: null,
    companiesProcessed: 0,
    totalCompanies: 0,
    isComplete: false,
    jobId: null, // ðŸ†• added
    maxProgressChecks: 300,
    progressCheckCount: 0,
    errorCount: 0,
    maxErrors: 5,

    show: function(options) {
        const overlay = document.getElementById('loadingOverlay');
        const title = document.getElementById('loadingTitle');
        const subtext = document.getElementById('loadingSubtext');
        const cancelBtn = document.getElementById('cancelBtn');
        const completionStatus = document.getElementById('completionStatus');
        
        this.reset();
        completionStatus.style.display = 'none';
        
        this.totalCompanies = options.totalCompanies || 0;
        this.jobId = options.jobId || null; // ðŸ†• store job ID
        
        title.textContent = options.text || 'Processing Companies';
        subtext.textContent = options.subtext || 'Initializing AI enrichment...';
        
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('progressPercentage').textContent = '0%';
        
        overlay.style.display = 'flex';
        
        cancelBtn.onclick = () => {
            if (confirm('Are you sure you want to cancel the data enrichment process?')) {
                this.hide();
                window.location.reload();
            }
        };
        
        overlay.onclick = e => { if (e.target === overlay) e.stopPropagation(); };
    },
    
    hide: function() {
        document.getElementById('loadingOverlay').style.display = 'none';
        this.reset();
    },
    
    reset: function() {
        this.companiesProcessed = 0;
        this.totalCompanies = 0;
        this.isComplete = false;
        this.progressCheckCount = 0;
        this.errorCount = 0;
        clearInterval(this.checkInterval);
    },
    
    startRealProgressTracking: function(jobId) {
        this.jobId = jobId;
        this.checkInterval = setInterval(() => this.checkServerProgress(), 2000);
    },
    
    async checkServerProgress() {
        if (!this.jobId) return;
        this.progressCheckCount++;
        if (this.progressCheckCount > this.maxProgressChecks) {
            this.showCompletion(true);
            return;
        }
        
        try {
            const response = await fetch(`/ai_agent/enrichment_progress/${this.jobId}/`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            const progress = await response.json();
            
            this.errorCount = 0;
            
            if (progress.is_complete) {
                progress.companies_processed = this.totalCompanies;
            }
            
            // âœ… Update progress display
            this.updateProgressDisplay(progress);

            // âœ… If the process is complete and a download link is provided
            if (progress.is_complete && progress.download_url) {
                this.isComplete = true;
                clearInterval(this.checkInterval);

                const completionStatus = document.getElementById('completionStatus');
                completionStatus.style.display = 'block';
                completionStatus.innerHTML = `
                    <div class="status-success">
                        <i class="fas fa-check-circle"></i>
                        <span>Processing complete! 
                            <a href="${progress.download_url}" class="btn btn-sm btn-success ms-2">
                                <i class="fas fa-download me-1"></i>Download Excel
                            </a>
                        </span>
                    </div>
                `;

                document.getElementById('progressFill').style.width = '100%';
                document.getElementById('progressPercentage').textContent = '100%';
                document.getElementById('timeRemaining').textContent = 'Complete!';
                
                // Update cancel button to close overlay
                const cancelBtn = document.getElementById('cancelBtn');
                cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>Close';
                cancelBtn.onclick = () => this.hide();
                
                return;
            }

            // âœ… Otherwise, check if itâ€™s just finished without a download link
            if ((progress.is_complete || this.companiesProcessed >= this.totalCompanies) && !this.isComplete) {
                this.isComplete = true;
                clearInterval(this.checkInterval);
                this.showCompletion();
            }
        } catch (error) {
            this.errorCount++;
            if (this.errorCount >= this.maxErrors) {
                this.showCompletion(true);
            }
        }
    },
    
    updateProgressDisplay: function(progress) {
        const progressFill = document.getElementById('progressFill');
        const progressPercentage = document.getElementById('progressPercentage');
        const timeRemaining = document.getElementById('timeRemaining');
        
        this.companiesProcessed = progress.companies_processed || 0;
        this.totalCompanies = progress.total_companies || 1;
        
        const percentage = Math.min(100, (this.companiesProcessed / this.totalCompanies) * 100);
        
        progressFill.style.width = `${percentage}%`;
        progressPercentage.textContent = `${Math.round(percentage)}%`;
        
        this.updateTimeEstimate(timeRemaining, percentage);
    },
    
    updateTimeEstimate: function(timeRemainingEl, percentage) {
        if (percentage >= 100) timeRemainingEl.textContent = 'Complete!';
        else if (percentage >= 95) timeRemainingEl.textContent = 'Almost done...';
        else if (percentage >= 80) timeRemainingEl.textContent = 'Less than 1 minute remaining';
        else if (percentage >= 50) timeRemainingEl.textContent = 'About 2 minutes remaining';
        else if (percentage >= 25) timeRemainingEl.textContent = 'About 4 minutes remaining';
        else timeRemainingEl.textContent = 'Calculating...';
    },
    
    showCompletion: function(isTimeout = false) {
        const timeRemaining = document.getElementById('timeRemaining');
        const completionStatus = document.getElementById('completionStatus');
        const cancelBtn = document.getElementById('cancelBtn');
        
        document.getElementById('progressFill').style.width = '100%';
        document.getElementById('progressPercentage').textContent = '100%';
        
        timeRemaining.textContent = 'Complete!';
        completionStatus.style.display = 'block';
        
        cancelBtn.innerHTML = '<i class="fas fa-times me-1"></i>Close';
        cancelBtn.onclick = () => this.hide();
        
        if (isTimeout) {
            completionStatus.innerHTML = `
                <div class="status-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>Process taking longer than expected. The download may appear shortly.</span>
                </div>
            `;
            completionStatus.style.background = 'rgba(255, 193, 7, 0.1)';
            completionStatus.style.borderLeftColor = '#ffc107';
        }
        
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn && window.originalButtonHTML) {
            submitBtn.disabled = false;
            submitBtn.classList.remove('btn-loading');
            submitBtn.innerHTML = window.originalButtonHTML;
        }
        
        setTimeout(() => this.hide(), 5000);
    }
};

document.addEventListener('DOMContentLoaded', () => LoadingManager.hide());
window.addEventListener('pageshow', event => { if (event.persisted) LoadingManager.hide(); });
</script>
